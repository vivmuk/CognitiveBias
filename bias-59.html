<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Loading Bias #59... - Cognitive Bias Learning Hub</title>

    <!-- Icons -->
    <link rel="icon" type="image/x-icon" href="Cog/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="Cog/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="Cog/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="Cog/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="57x57" href="Cog/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="Cog/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="Cog/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="Cog/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="Cog/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="Cog/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="Cog/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="Cog/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="Cog/apple-icon-180x180.png">
    <link rel="apple-touch-icon" href="Cog/apple-icon.png">
    <link rel="manifest" href="Cog/manifest.json">
    <meta name="msapplication-TileColor" content="#0f3460">
    <meta name="msapplication-TileImage" content="Cog/ms-icon-144x144.png">
    <meta name="msapplication-config" content="Cog/browserconfig.xml">
    <meta name="theme-color" content="#0f3460">

    <!-- Fonts & Styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Outfit:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Data & Logic -->
    <script src="all-99-biases.js"></script>
    <script src="venice-api.js"></script>
</head>

<body class="bias-detail-body">
    <div class="progress-indicator">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="floating-nav">
        <span class="floating-nav-label">On this page</span>
        <a href="#overview" class="nav-item active" onclick="scrollToSection('overview', this)">Overview</a>
        <a href="#signals" class="nav-item" onclick="scrollToSection('signals', this)">Signals</a>
        <a href="#details" class="nav-item" onclick="scrollToSection('details', this)">Deep Dive</a>
        <a href="#examples" class="nav-item" onclick="scrollToSection('examples', this)">Examples</a>
        <a href="#quiz" class="nav-item" onclick="scrollToSection('quiz', this)">Quiz</a>
        <a href="#explore" class="nav-item" onclick="scrollToSection('explore', this)">AI Lab</a>
    </div>

    <div class="bias-page-shell">
        <div class="navigation-bar">
            <a href="index.html" class="back-link">
                <svg fill="none" viewBox="0 0 24 24">
                    <path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span>Back to Bias Library</span>
            </a>
            <div class="nav-right">
                <span class="nav-pill" id="biasCounter">Bias #59 / 99</span>
                <div class="nav-controls">
                    <a href="bias-58.html" class="ghost-button">Previous</a>
                    <a href="bias-60.html" class="ghost-button">Next</a>
                </div>
            </div>
        </div>

        <header id="overview" class="bias-hero">
            <div>
                <p class="eyebrow" id="categoryEyebrow">Category Focus</p>
                <h1 class="text-4xl md:text-5xl font-extrabold mb-4" id="biasTitle">Loading...</h1>
                <p class="text-xl text-slate-300 italic mb-4" id="biasSubtitle">Subtitle</p>
                <p class="lead" id="heroSummary">Summary</p>
                <div class="hero-meta">
                    <span class="meta-chip accent" id="metaCategory">Category</span>
                    <span class="meta-chip" id="metaDifficulty">Difficulty</span>
                    <span class="meta-chip" id="metaChapter">Chapter #</span>
                </div>
                <div class="hero-cta">
                    <button type="button" class="primary-btn" onclick="completeLesson()">Mark Lesson Complete</button>
                    <button type="button" class="secondary-btn" onclick="scrollToSection('quiz')">Jump to Quiz</button>
                </div>
            </div>
            <div class="hero-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg class="w-6 h-6 text-cyan-300" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M3 16l6-6 4 4 8-8" />
                        </svg>
                    </div>
                    <div>
                        <p class="stat-label">Essential Theme</p>
                        <p class="stat-value" id="statTheme">...</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg class="w-6 h-6 text-purple-300" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M12 6v6l4 2" />
                        </svg>
                    </div>
                    <div>
                        <p class="stat-label">Difficulty</p>
                        <p class="stat-value" id="statDifficulty">...</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg class="w-6 h-6 text-emerald-300" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M5 12h14M12 5l7 7-7 7" />
                        </svg>
                    </div>
                    <div>
                        <p class="stat-label">Progress Status</p>
                        <p class="stat-value" id="statProgress">Not started</p>
                    </div>
                </div>
            </div>
        </header>

        <section id="signals" class="content-card layered-panel mt-10">
            <div class="section-heading">
                <div>
                    <h2 class="text-3xl font-bold mb-2">Spot the Signal</h2>
                    <p id="spotIntro">Identify the cues before the bias takes over.</p>
                </div>
                <span class="badge-pill">Field Notes</span>
            </div>
            <div class="insight-grid">
                <article class="insight-card">
                    <h3>Where it shows up</h3>
                    <p id="spotSummary">...</p>
                </article>
                <article class="insight-card">
                    <h3>What to watch</h3>
                    <p id="spotDetect">...</p>
                </article>
                <article class="insight-card">
                    <h3>Why it fools us</h3>
                    <p id="spotPsychology">...</p>
                </article>
            </div>
            <div class="callout mt-6">
                <strong>Key reminder:</strong>
                <p class="mt-2" id="calloutText">...</p>
            </div>
        </section>

        <section id="details" class="content-card layered-panel mt-10">
            <div class="section-heading">
                <div>
                    <h2 class="text-3xl font-bold mb-2">Build a Better Lens</h2>
                    <p>Translate awareness into applied judgment.</p>
                </div>
                <span class="badge-pill">Practice</span>
            </div>
            <div class="detail-layout">
                <div>
                    <h3 class="text-2xl font-semibold mb-3">Deep Explanation</h3>
                    <p class="text-slate-200" id="deepExplanation">...</p>
                    <ul class="detail-list" id="countermeasureList"></ul>
                </div>
                <div class="callout">
                    <strong>Detection cue</strong>
                    <p class="mt-2" id="detectionCallout">...</p>
                </div>
            </div>
        </section>

        <section id="examples" class="content-card case-study mt-10">
            <div class="section-heading">
                <div>
                    <h2 class="text-3xl font-bold mb-2">Real-world Pattern Watch</h2>
                    <p>Ground the concept with a concrete scenario.</p>
                </div>
                <span class="badge-pill">Case Study</span>
            </div>
            <div class="case-grid">
                <div>
                    <div class="case-label" id="caseLabel">Case Study</div>
                    <p id="exampleText">...</p>
                </div>
                <div class="case-metrics">
                    <div class="case-metric">
                        <p class="uppercase tracking-wide text-xs text-slate-300 mb-1">Category</p>
                        <span id="caseCategory">...</span>
                        <p class="text-slate-400 text-sm">Primary arena</p>
                    </div>
                    <div class="case-metric">
                        <p class="uppercase tracking-wide text-xs text-slate-300 mb-1">Difficulty</p>
                        <span id="caseDifficulty">...</span>
                        <p class="text-slate-400 text-sm">Relative mastery effort</p>
                    </div>
                    <div class="case-metric">
                        <p class="uppercase tracking-wide text-xs text-slate-300 mb-1">Theme</p>
                        <span id="caseTheme">...</span>
                        <p class="text-slate-400 text-sm">Pattern headline</p>
                    </div>
                </div>
            </div>
            <div class="timeline mt-8">
                <div class="timeline-item">
                    <span class="timeline-marker"></span>
                    <h4>Spot it</h4>
                    <p id="timelineSpot">...</p>
                </div>
                <div class="timeline-item">
                    <span class="timeline-marker"></span>
                    <h4>Evaluate</h4>
                    <p id="timelineEvaluate">...</p>
                </div>
                <div class="timeline-item">
                    <span class="timeline-marker"></span>
                    <h4>Respond</h4>
                    <p id="timelineRespond">...</p>
                </div>
            </div>
        </section>

        <section id="quiz" class="quiz-container mt-10">
            <div class="section-heading">
                <div>
                    <h2 class="text-3xl font-bold mb-2">Test Your Intuition</h2>
                    <p>Quick pulse-check to lock in the concept.</p>
                </div>
                <span class="badge-pill">3 min</span>
            </div>
            <div id="quizContent">
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-4" id="quizQuestion">Loading question...</h3>
                    <div class="space-y-3" id="quizOptions"></div>
                </div>
                <div id="quizResult" class="hidden mt-6">
                    <div id="resultText"></div>
                    <button onclick="completeLesson()" 
                        class="mt-4 px-6 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors">
                        Mark as Complete & Continue
                    </button>
                </div>
            </div>
        </section>

        <section id="explore" class="deep-dive-section mt-10">
            <div class="section-heading">
                <div>
                    <h2 class="text-3xl font-bold mb-2">Explore with the AI Mentor</h2>
                    <p>Unlock industry-specific examples, mitigation scripts, or custom prompts.</p>
                </div>
                <span class="badge-pill">Interactive</span>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3">Choose an exploration focus:</h3>
                <div class="flex flex-wrap gap-3">
                    <button class="exploration-button" data-explore-focus="true" onclick="exploreCategory('business', this)">Business Impact</button>
                    <button class="exploration-button" data-explore-focus="true" onclick="exploreCategory('personal', this)">Personal Life</button>
                    <button class="exploration-button" data-explore-focus="true" onclick="exploreCategory('scientific', this)">Scientific Research</button>
                    <button class="exploration-button" data-explore-focus="true" onclick="exploreCategory('historical', this)">Historical Lens</button>
                    <button class="exploration-button" data-explore-focus="true" onclick="exploreCategory('general', this)">Deep Psychology</button>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3">Or ask your own question:</h3>
                <textarea class="custom-prompt-area" placeholder="Ask anything about this bias..." id="customPrompt"></textarea>
                <button onclick="exploreCustom()" class="exploration-button mt-3">Get AI Insights</button>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3">Quick questions to explore:</h3>
                <div class="space-y-2" id="suggestedQuestions"></div>
            </div>

            <div id="aiResponse" class="hidden">
                <h3 class="text-xl font-bold mb-4 text-indigo-300">AI Insights</h3>
                <div id="responseContent" class="ai-response-viewer"></div>
            </div>

            <div id="loadingState" class="hidden text-center py-8">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-lg">Generating deep insights...</p>
            </div>
        </section>
    </div>

    <script>
        const veniceAPI = new VeniceAPIService();
        const BIAS_ID = 59;
        const sectionIds = ['overview', 'signals', 'details', 'examples', 'quiz', 'explore'];
        let currentBias = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadBiasData();
            updateProgress();
            highlightActiveSection();
        });

        function loadBiasData() {
            if (typeof all99CognitiveBiases === "undefined") {
                setTimeout(loadBiasData, 60);
                return;
            }

            const bias = all99CognitiveBiases.find(b => b.id === BIAS_ID);
            if (!bias) {
                document.body.innerHTML = '<div class="bias-page-shell"><h1 class="text-4xl font-bold mb-4">Bias #' + BIAS_ID + ' not found</h1><p class="text-slate-300">Please verify the data source.</p></div>';
                return;
            }

            currentBias = bias;
            populatePage(bias);
        }

        function populatePage(bias) {
            const difficulty = getBiasDifficulty(bias);
            const category = getBiasCategory(bias);
            const categoryLabel = formatCategoryLabel(category);

            document.title = bias.title + " - Cognitive Bias Learning Hub";
            setText('biasCounter', 'Bias #' + bias.id + ' / 99');
            setText('categoryEyebrow', categoryLabel + ' Focus');
            setText('biasTitle', bias.title);
            setText('biasSubtitle', bias.subtitle);
            setText('heroSummary', bias.summary);
            setText('metaCategory', categoryLabel);
            setText('metaDifficulty', difficulty);
            setText('metaChapter', 'Chapter ' + bias.id);
            setText('statTheme', bias.subtitle || bias.title);
            setText('statDifficulty', difficulty);
            setText('statProgress', getProgressLabel());
            setText('spotIntro', 'Use these cues when the conversation starts leaning on this bias.');
            setText('spotSummary', bias.summary);
            setText('spotDetect', bias.howToDetect);
            setText('spotPsychology', bias.psychologyInsight);
            setText('calloutText', bias.howToDetect);
            setText('deepExplanation', bias.detailedExplanation);
            setText('detectionCallout', bias.psychologyInsight);

            renderCountermeasures(bias.countermeasures || []);

            setText('caseLabel', bias.title + ' in the wild');
            setText('exampleText', bias.realWorldExample);
            setText('caseCategory', categoryLabel);
            setText('caseDifficulty', difficulty);
            setText('caseTheme', bias.subtitle || bias.title);
            setText('timelineSpot', bias.summary);
            setText('timelineEvaluate', bias.howToDetect);
            setText('timelineRespond', (bias.countermeasures && bias.countermeasures[0]) || 'Translate awareness into concrete actions.');

            renderQuiz(bias);

            const promptArea = document.getElementById('customPrompt');
            if (promptArea) {
                promptArea.placeholder = 'Ask anything about ' + bias.title + '...';
            }

            loadSuggestedQuestions();
        }

        function renderCountermeasures(list) {
            const container = document.getElementById('countermeasureList');
            if (!container) return;
            container.innerHTML = '';
            if (!list.length) {
                const li = document.createElement('li');
                li.textContent = 'Document at least one countermeasure for this bias.';
                container.appendChild(li);
                return;
            }
            list.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                container.appendChild(li);
            });
        }

        function renderQuiz(bias) {
            const quizQuestion = document.getElementById('quizQuestion');
            const quizOptions = document.getElementById('quizOptions');
            if (!quizQuestion || !quizOptions) return;

            quizQuestion.textContent = bias.quiz?.question || 'What best describes this bias?';
            quizOptions.innerHTML = '';

            const incorrect = bias.quiz?.incorrect || [];
            incorrect.forEach(option => {
                const button = document.createElement('button');
                button.className = 'quiz-option w-full text-left';
                button.textContent = option;
                button.onclick = () => selectAnswer(button, false);
                quizOptions.appendChild(button);
            });

            const correctButton = document.createElement('button');
            correctButton.className = 'quiz-option w-full text-left';
            correctButton.textContent = bias.quiz?.correct || 'Seek more data before deciding.';
            correctButton.onclick = () => selectAnswer(correctButton, true);
            quizOptions.appendChild(correctButton);

            const options = Array.from(quizOptions.children);
            for (let i = options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [options[i], options[j]] = [options[j], options[i]];
            }
            quizOptions.innerHTML = '';
            options.forEach(option => quizOptions.appendChild(option));
        }

        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = text || '';
            }
        }

        function getBiasDifficulty(bias) {
            const advancedIds = [7, 8, 15, 18, 19, 24, 25, 33, 55, 56, 58, 75, 76, 91, 92, 94, 97, 98, 99];
            const beginnerIds = [1, 2, 4, 6, 10, 13, 22];
            if (advancedIds.includes(bias.id)) return 'Advanced';
            if (beginnerIds.includes(bias.id)) return 'Beginner';
            return 'Intermediate';
        }

        function getBiasCategory(bias) {
            const title = bias.title.toLowerCase();
            const id = bias.id;

            if (title.includes('probability') || title.includes('base rate') || title.includes('gambler') ||
                title.includes('regression') || title.includes('clustering') || title.includes('coincidence') ||
                title.includes('survivorship') || title.includes('swimmer') ||
                [1, 2, 3, 19, 24, 26, 27, 28, 33, 55, 58, 61, 75, 95, 96, 97].includes(id)) {
                return 'probability';
            }

            if (title.includes('social') || title.includes('group') || title.includes('authority') ||
                title.includes('reciprocity') || title.includes('in-group') ||
                [4, 6, 9, 18, 22, 25, 32, 35, 36, 37, 38, 65, 66, 72, 77, 79, 86, 87, 89].includes(id)) {
                return 'social';
            }

            if (title.includes('memory') || title.includes('hindsight') || title.includes('story') ||
                title.includes('primacy') || title.includes('recency') ||
                [13, 14, 43, 46, 62, 64, 70, 73, 78, 88, 93].includes(id)) {
                return 'memory';
            }

            return 'decision-making';
        }

        function formatCategoryLabel(category) {
            const labels = {
                'decision-making': 'Decision Making',
                'social': 'Social Dynamics',
                'memory': 'Memory & Recall',
                'probability': 'Probability & Logic'
            };
            return labels[category] || 'Decision Making';
        }

        function getProgressLabel() {
            const progressData = JSON.parse(localStorage.getItem('biasProgress') || '{}');
            const status = progressData[BIAS_ID];
            if (status === 'completed') return 'Mastered';
            if (status === 'in-progress') return 'In progress';
            return 'Not started';
        }

        function scrollToSection(sectionId, trigger) {
            const target = document.getElementById(sectionId);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            document.querySelectorAll('.floating-nav .nav-item').forEach(item => item.classList.remove('active'));
            if (trigger) {
                trigger.classList.add('active');
            } else {
                const navItem = document.querySelector('.floating-nav .nav-item[href="#' + sectionId + '"]');
                if (navItem) navItem.classList.add('active');
            }
        }

        function updateProgress() {
            const scrollPosition = window.scrollY;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            const progress = (scrollPosition / (documentHeight - windowHeight)) * 100;
            document.getElementById('progressFill').style.width = Math.min(progress, 100) + '%';
        }

        function highlightActiveSection() {
            let current = sectionIds[0];
            sectionIds.forEach(id => {
                const section = document.getElementById(id);
                if (!section) return;
                const rect = section.getBoundingClientRect();
                if (rect.top <= window.innerHeight * 0.35) {
                    current = id;
                }
            });
            document.querySelectorAll('.floating-nav .nav-item').forEach(item => item.classList.remove('active'));
            const activeLink = document.querySelector('.floating-nav .nav-item[href="#' + current + '"]');
            if (activeLink) activeLink.classList.add('active');
        }

        function selectAnswer(button, isCorrect) {
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.disabled = true;
                option.style.cursor = 'default';
            });

            if (isCorrect) {
                button.style.background = 'rgba(34, 197, 94, 0.8)';
                button.style.borderColor = 'rgb(34, 197, 94)';
            } else {
                button.style.background = 'rgba(239, 68, 68, 0.8)';
                button.style.borderColor = 'rgb(239, 68, 68)';
                document.querySelectorAll('.quiz-option').forEach(option => {
                    if (option.onclick && option.onclick.toString().includes('true')) {
                        option.style.background = 'rgba(34, 197, 94, 0.8)';
                        option.style.borderColor = 'rgb(34, 197, 94)';
                    }
                });
            }

            const resultDiv = document.getElementById('quizResult');
            const resultText = document.getElementById('resultText');

            if (isCorrect) {
                resultText.innerHTML = '<h4 class="font-bold text-green-300 mb-2 text-lg">Nice work!</h4><p class="text-slate-200">You recognized the core of ' + currentBias.title + '.</p>';
            } else {
                resultText.innerHTML = '<h4 class="font-bold text-red-300 mb-2 text-lg">Almost.</h4><p class="text-slate-200">Review the sections above and try again.</p>';
            }

            resultDiv.classList.remove('hidden');

            const score = isCorrect ? 100 : 0;
            let quizScores = JSON.parse(localStorage.getItem('quizScores') || '{}');
            quizScores[BIAS_ID] = score;
            localStorage.setItem('quizScores', JSON.stringify(quizScores));
        }

        function completeLesson() {
            let progressData = JSON.parse(localStorage.getItem('biasProgress') || '{}');
            progressData[BIAS_ID] = 'completed';
            localStorage.setItem('biasProgress', JSON.stringify(progressData));

            alert('Great work! ' + currentBias.title + ' is now marked as complete.');
            const nextId = BIAS_ID === 99 ? 1 : BIAS_ID + 1;
            if (confirm('Continue to the next bias?')) {
                window.location.href = 'bias-' + nextId + '.html';
            } else {
                window.location.href = 'index.html';
            }
        }

        function loadSuggestedQuestions() {
            if (!currentBias) return;
            const questions = veniceAPI.getSuggestedQuestions(currentBias.title);
            const container = document.getElementById('suggestedQuestions');
            if (!container) return;
            container.innerHTML = '';
            questions.forEach(question => {
                const button = document.createElement('button');
                button.className = 'exploration-button text-sm';
                button.textContent = question;
                button.onclick = () => exploreQuestion(question);
                container.appendChild(button);
            });
        }

        function clearFocusButtons() {
            document.querySelectorAll('[data-explore-focus="true"]').forEach(btn => btn.classList.remove('active'));
        }

        async function exploreCategory(category, trigger) {
            showLoading();
            clearFocusButtons();
            if (trigger) trigger.classList.add('active');

            try {
                const response = await veniceAPI.generateDeepExploration(
                    currentBias.title,
                    currentBias.summary,
                    category
                );
                showAIResponse(response);
            } catch (error) {
                showAIResponse("I’m having trouble reaching the AI service right now. Please try again shortly.");
            }
        }

        async function exploreCustom() {
            const customPrompt = document.getElementById('customPrompt').value.trim();
            if (!customPrompt) {
                alert('Please enter a question or topic you would like to explore.');
                return;
            }

            showLoading();

            try {
                const response = await veniceAPI.generateCustomPrompt(
                    currentBias.title,
                    currentBias.summary,
                    customPrompt
                );
                showAIResponse(response);
            } catch (error) {
                showAIResponse("I’m having trouble reaching the AI service right now. Please try again shortly.");
            }
        }

        async function exploreQuestion(question) {
            showLoading();
            try {
                const response = await veniceAPI.generateCustomPrompt(
                    currentBias.title,
                    currentBias.summary,
                    question
                );
                showAIResponse(response);
            } catch (error) {
                showAIResponse("I’m having trouble reaching the AI service right now. Please try again shortly.");
            }
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('aiResponse').classList.add('hidden');
        }

        function showAIResponse(content) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('responseContent').innerHTML = formatAIResponse(content);
            document.getElementById('aiResponse').classList.remove('hidden');
            document.getElementById('aiResponse').scrollIntoView({ behavior: 'smooth' });
        }

        function formatAIResponse(content) {
            let formatted = content
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^[0-9]+\.\s+(.*$)/gim, '<li>$1</li>')
                .replace(/^[-*]\s+(.*$)/gim, '<li>$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');

            formatted = '<p>' + formatted + '</p>';
            formatted = formatted.replace(/(<li>.*?<\/li>)/gs, match => {
                const listItems = match.match(/<li>.*?<\/li>/g);
                return '<ul>' + listItems.join('') + '</ul>';
            });

            formatted = formatted.replace(/<p><\/p>/g, '');
            formatted = formatted.replace(/<p>(<h[1-6]>)/g, '$1');
            formatted = formatted.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
            formatted = formatted.replace(/<p>(<ul>)/g, '$1');
            formatted = formatted.replace(/(<\/ul>)<\/p>/g, '$1');

            return formatted;
        }

        window.addEventListener('scroll', () => {
            updateProgress();
            highlightActiveSection();
        });
    </script>
</body>
</html>